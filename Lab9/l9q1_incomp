//Not compplete
#include <LPC17xx.h>

int flag1,flag2,temp1,temp2;


void port_write()
{
	int i;
	LPC_GPIO0->FIOPIN=temp2<<23;
	if(flag1==0)
	  LPC_GPIO0->FIOCLR=1<<27;
	else
		LPC_GPIO0->FIOSET=1<<27;
	LPC_GPIO0->FIOSET=1<<28;
	for(i=0;i<20;i++);
	LPC_GPIO0->FIOCLR=1<<28;
	for(i=0;i<30000;i++);
	
}

void LCD_Write()
{
	flag2 = (flag1 == 1) ? 0 :((temp1 == 0x30) || (temp1 == 0x20)) ? 1 : 0;
	temp2=(temp1&0xF0)>>4;
	port_write();
	if(flag2==0)
	{
		temp2=temp1&0xf;
		port_write();
	}
}

int main()
{
	char s[100];
	int LCD_init[]={0x30,0x30,0x30,0x20,0x28,0x0c,0x01,0x80,0x06};
	int i,x,col,row,key,j,s_pos=0;
	SystemInit();
	SystemCoreClockUpdate();
	LPC_PINCON->PINSEL1=0;
	LPC_GPIO0->FIODIR=3<<27 | 0xF<<23; //P0.27 FOR RS, P0.28 FOR ENABLE, P0.26 TO P0.23 FOR DATA LINES
	LPC_PINCON->PINSEL0=0;
	LPC_PINCON->PINSEL1=0;
  LPC_PINCON->PINSEL3=0;
	LPC_PINCON->PINSEL4=0;
	LPC_GPIO0->FIODIR=0XFF<<4 | 0XF<<15 ;  //PO.11 TO P0.4->SEVEN SEG PO.18 TO PO.15->DECODER
	LPC_GPIO1->FIODIR=0;   //P1.26 TO P1.23->COLS
	LPC_GPIO2->FIODIR=0XF<<10;  //P2.13 TO P2.10->ROWS
	LPC_GPIO0->FIOPIN=0;
	while(1)
	{
		for(i=0;i<4;i++)
		{
			LPC_GPIO2->FIOPIN=1<<(10+i);
			x=LPC_GPIO1->FIOPIN;
			for(j=0;j<50;i++);
			x=(x>>23)&0xf;
			if(x!=0)
			{
				if(x==1)
					col=0;
				else if(x==2)
					col=1;
				else if(x==4)
					col=2;
				else if(x==8)
					col=3;
				row=i;
				break;
			}
		}
		if(x!=0)
		{
			key=4*row+col;
			s[s_pos++]=key+48;
		}
	}
	flag1=0;
	for(i=0;i<=8;i++)
	{
		temp1=LCD_init[i];
		LCD_Write();
	}
	flag1=1;
	for(i=0;s[i]!='\0';i++)
	{
		if(i==16)
		{
			flag1=0;
			temp1=0xc0;
			LCD_Write();
			flag1=1;
		}
		temp1=s[i];
		LCD_Write();
	}
}
